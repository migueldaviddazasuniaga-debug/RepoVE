<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadolar Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES Y ANIMACIONES 3D --- */
        body { background-color: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; user-select: none; overflow: hidden; }
        
        /* Contenedor de la escena 3D */
        .scene { perspective: 1000px; width: 375px; height: 680px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        
        /* Caras de la tarjeta */
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 40px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
        .card-back { transform: rotateY(180deg); background-color: #121212; }
        
        /* Utiler√≠as Inputs */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .ios-btn:active { opacity: 0.7; transform: scale(0.95); transition: transform 0.1s; }
        
        /* Animaci√≥n Historial */
        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 300px; opacity: 1; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-black">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const COLORS = {
            vinotinto: '#800020',
            iosOrange: '#ff9f0a',
            iosDarkGray: '#333333',
            iosLightGray: '#a5a5a5',
            green: '#2ecc71',
            red: '#e74c3c',
            yellow: '#f1c40f'
        };

        const App = () => {
            // --- ESTADOS ---
            const [isFlipped, setIsFlipped] = useState(false); // Controla el giro 3D
            
            // Calculadora
            const [calcDisplay, setCalcDisplay] = useState('0');
            const [waitingForOperand, setWaitingForOperand] = useState(false);
            const [operator, setOperator] = useState(null);
            const [value, setValue] = useState(null);

            // Herramienta
            const [loading, setLoading] = useState(false);
            const [rates, setRates] = useState({ bcv: 46.20, paralelo: 54.50, euro: 49.10, binance: 55.02, promedio: 52.30 });
            
            const [inputs, setInputs] = useState({
                priceDollar: '',
                payAmount: '',
                currency: 'Bs', // Dropdown: 'Bs' o '$'
                customBcv: '',
                customParalelo: ''
            });

            const [log, setLog] = useState([]);
            const [showHistory, setShowHistory] = useState(false);

            // --- 1. FETCH API REAL (L√≥gica de calcu4.html) ---
            const fetchRates = async () => {
                setLoading(true);
                try {
                    const res = await fetch('https://ve.dolarapi.com/v1/dolares');
                    if(res.ok) {
                        const data = await res.json();
                        const oficial = data.find(d => d.fuente === 'oficial') || {};
                        const paralelo = data.find(d => d.fuente === 'paralelo') || {};
                        
                        setRates(prev => ({
                            ...prev,
                            bcv: oficial.promedio || prev.bcv,
                            paralelo: paralelo.promedio || prev.paralelo,
                            // Datos extra para el ticker
                            binance: (data.find(d => d.titulo === 'Binance') || {}).promedio || prev.binance
                        }));
                    }
                } catch (e) {
                    console.error("Error fetching rates", e);
                } finally {
                    setLoading(false);
                }
            };

            // Cargar tasas al iniciar
            useEffect(() => { fetchRates(); }, []);

            // --- 2. CAMUFLAJE (676767) ---
            useEffect(() => {
                if (calcDisplay === '676767') {
                    setTimeout(() => {
                        setIsFlipped(true); // Activa el giro
                        setCalcDisplay('0');
                        setValue(null);
                        setOperator(null);
                    }, 300);
                }
            }, [calcDisplay]);

            // --- 3. L√ìGICA DE C√ÅLCULO (Motor de calcu4.html) ---
            
            // Determinar tasa activa (Input manual o API)
            const activeBcv = inputs.customBcv !== '' ? parseFloat(inputs.customBcv) : rates.bcv;
            const activeParalelo = inputs.customParalelo !== '' ? parseFloat(inputs.customParalelo) : rates.paralelo;
            const basePrice = parseFloat(inputs.priceDollar);
            const payAmount = parseFloat(inputs.payAmount);

            // C√°lculos para Textos Chiquitos (Micro-Info)
            let infoBaseText = "Ingresa precio...";
            if (basePrice > 0) {
                infoBaseText = `Oficial: Bs ${(basePrice * activeBcv).toFixed(2)} | Par: Bs ${(basePrice * activeParalelo).toFixed(2)}`;
            }

            let infoPayText = "Ingresa pago...";
            if (payAmount > 0) {
                if (inputs.currency === 'Bs') {
                    // Me piden Bs
                    const eqDolarBCV = (payAmount / activeBcv).toFixed(2);
                    const eqDolarPar = (payAmount / activeParalelo).toFixed(2);
                    infoPayText = `Equivale a: $${eqDolarPar} (Par) | $${eqDolarBCV} (BCV)`;
                } else {
                    // Me piden $
                    const eqBsBCV = (payAmount * activeBcv).toFixed(2);
                    const eqBsPar = (payAmount * activeParalelo).toFixed(2);
                    infoPayText = `Son: Bs ${eqBsBCV} (BCV) | Bs ${eqBsPar} (Par)`;
                }
            }

            // C√°lculo Tasa Impl√≠cita y Sem√°foro
            let tasaImplicita = 0;
            let statusColor = 'text-gray-500';
            let statusBg = 'bg-gray-800';
            let statusText = 'ESPERANDO DATOS';
            let analysisText = '';

            if (basePrice > 0 && payAmount > 0) {
                if (inputs.currency === 'Bs') {
                    tasaImplicita = payAmount / basePrice;
                } else {
                    // L√≥gica calcu4: Si piden $ (para pagar en Bs a tasa X), convertimos lo que piden a Bs (usando BCV como referencia base legal) y dividimos por precio base
                    // Ojo: Si te piden $12 por algo de $10, es sobreprecio puro.
                    // Para mantener la consistencia con calcu4:
                    const bsEstimados = payAmount * activeBcv; 
                    tasaImplicita = bsEstimados / basePrice;
                    // Correcci√≥n l√≥gica simple: Si me piden $12 por algo de $10, el ratio es 1.2.
                    // Multiplicamos por la tasa actual para ver la "Tasa Impl√≠cita en Bs".
                    tasaImplicita = (payAmount / basePrice) * activeBcv; 
                }

                // Sem√°foro (L√≥gica calcu4)
                if (tasaImplicita <= (activeBcv * 1.01)) {
                    statusColor = 'text-green-400';
                    statusBg = 'bg-green-900/30 border border-green-600';
                    statusText = 'EXCELENTE (OFICIAL)';
                    analysisText = 'Te est√°n cobrando a tasa BCV real.';
                } else if (tasaImplicita >= (activeParalelo * 0.98)) {
                    statusColor = 'text-red-400';
                    statusBg = 'bg-red-900/30 border border-red-600';
                    statusText = 'ALERTA: TASA PARALELA';
                    analysisText = 'Precio inflado a tasa paralela.';
                } else {
                    statusColor = 'text-yellow-400';
                    statusBg = 'bg-yellow-900/30 border border-yellow-600';
                    statusText = 'TASA MIXTA / INFLADA';
                    analysisText = 'Es m√°s caro que BCV, cuidado.';
                }
            }


            // --- UTILS ---
            const handleRateBlur = (field) => {
                if (inputs[field] === '' || isNaN(parseFloat(inputs[field]))) {
                    setInputs(prev => ({ ...prev, [field]: '' }));
                }
            };

            const saveLog = () => {
                if (tasaImplicita > 0) {
                    const newEntry = {
                        id: Date.now(),
                        date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        price: inputs.priceDollar,
                        paid: inputs.payAmount,
                        currency: inputs.currency,
                        rate: tasaImplicita.toFixed(2),
                        status: statusText.includes('ALERTA') ? 'red' : statusText.includes('EXCELENTE') ? 'green' : 'yellow'
                    };
                    setLog([newEntry, ...log]);
                    setShowHistory(true);
                }
            };

            // L√≥gica Calculadora B√°sica
            const inputDigit = (d) => waitingForOperand ? (setCalcDisplay(String(d)), setWaitingForOperand(false)) : setCalcDisplay(calcDisplay === '0' ? String(d) : calcDisplay + d);
            const performOperation = (op) => {
                const inputValue = parseFloat(calcDisplay);
                if (value === null) setValue(inputValue);
                else if (operator) {
                    const current = value || 0;
                    const result = op === '+' ? current + inputValue : op === '-' ? current - inputValue : op === '*' ? current * inputValue : op === '/' ? current / inputValue : inputValue;
                    setValue(result); setCalcDisplay(String(result));
                }
                setWaitingForOperand(true); setOperator(op);
            };
            const clearCalc = () => { setCalcDisplay('0'); setValue(null); setOperator(null); setWaitingForOperand(false); };

            // Componente Bot√≥n Calc
            const CalcBtn = ({ l, type, onClick, d }) => {
                let bg = type === 'o' ? COLORS.iosOrange : type === 't' ? COLORS.iosLightGray : COLORS.iosDarkGray;
                let txt = type === 't' ? 'black' : 'white';
                return <button onClick={onClick} className={`ios-btn ${d ? 'col-span-2 rounded-full' : 'rounded-full'} h-16 w-full flex items-center justify-center text-3xl font-medium`} style={{backgroundColor: bg, color: txt}}>{l}</button>;
            };

            return (
                <div className="scene">
                    <div className={`card-inner ${isFlipped ? 'flipped' : ''}`}>
                        
                        {/* --- CARA FRONTAL: CALCULADORA --- */}
                        <div className="card-face bg-black text-white p-5 flex flex-col justify-end">
                            <div className="w-full h-32 flex items-end justify-end px-4 mb-4">
                                <span className="text-7xl font-light tracking-tight truncate">{calcDisplay}</span>
                            </div>
                            <div className="w-full grid grid-cols-4 gap-3">
                                <CalcBtn l="AC" type="t" onClick={clearCalc} />
                                <CalcBtn l="+/-" type="t" onClick={()=>{}} />
                                <CalcBtn l="%" type="t" onClick={()=>{}} />
                                <CalcBtn l="√∑" type="o" onClick={() => performOperation('/')} />
                                <CalcBtn l="7" onClick={() => inputDigit(7)} />
                                <CalcBtn l="8" onClick={() => inputDigit(8)} />
                                <CalcBtn l="9" onClick={() => inputDigit(9)} />
                                <CalcBtn l="√ó" type="o" onClick={() => performOperation('*')} />
                                <CalcBtn l="4" onClick={() => inputDigit(4)} />
                                <CalcBtn l="5" onClick={() => inputDigit(5)} />
                                <CalcBtn l="6" onClick={() => inputDigit(6)} />
                                <CalcBtn l="-" type="o" onClick={() => performOperation('-')} />
                                <CalcBtn l="1" onClick={() => inputDigit(1)} />
                                <CalcBtn l="2" onClick={() => inputDigit(2)} />
                                <CalcBtn l="3" onClick={() => inputDigit(3)} />
                                <CalcBtn l="+" type="o" onClick={() => performOperation('+')} />
                                <CalcBtn l="0" d onClick={() => inputDigit(0)} />
                                <CalcBtn l="," onClick={() => inputDigit('.')} />
                                <CalcBtn l="=" type="o" onClick={() => performOperation('=')} />
                            </div>
                        </div>

                        {/* --- CARA TRASERA: HERRAMIENTA --- */}
                        <div className="card-face card-back p-5 flex flex-col font-sans text-white">
                            
                            {/* Bot√≥n Salir */}
                            <button onClick={() => setIsFlipped(false)} className="absolute top-5 right-5 p-2 rounded-full bg-gray-800 text-red-500 z-50 hover:bg-gray-700">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>

                            {/* Header */}
                            <div className="flex items-center gap-3 mt-2 mb-1">
                                <h1 className="text-2xl font-bold text-red-600 tracking-tight">Calculadolar üáªüá™</h1>
                                <button onClick={fetchRates} className={`p-2 bg-gray-800 rounded-full text-gray-300 ${loading ? 'animate-spin' : ''}`}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                                </button>
                            </div>

                            {/* Ticker */}
                            <div className="flex gap-4 text-xs font-mono text-yellow-500/90 mb-4 overflow-x-auto pb-2 border-b border-gray-800 whitespace-nowrap">
                                <span>EUR: {rates.euro}</span> ‚Ä¢ <span>BIN: {rates.binance}</span> ‚Ä¢ <span>PROM: {rates.promedio}</span>
                            </div>

                            <div className="flex flex-col gap-4">
                                {/* Fila 1: Tasas */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex flex-col gap-1">
                                        <label className="text-xs text-green-500 font-bold ml-1">Tasa BCV</label>
                                        <input type="number" placeholder={rates.bcv} value={inputs.customBcv} onChange={(e) => setInputs({...inputs, customBcv: e.target.value})} onBlur={() => handleRateBlur('customBcv')} className="w-full bg-[#1c1c1e] border border-green-600 text-green-500 p-3 rounded-xl focus:outline-none focus:ring-1 focus:ring-green-500 text-xl font-bold placeholder-green-500/50 text-center" />
                                    </div>
                                    <div className="flex flex-col gap-1">
                                        <label className="text-xs text-red-500 font-bold ml-1">Tasa Paralelo</label>
                                        <input type="number" placeholder={rates.paralelo} value={inputs.customParalelo} onChange={(e) => setInputs({...inputs, customParalelo: e.target.value})} onBlur={() => handleRateBlur('customParalelo')} className="w-full bg-[#1c1c1e] border border-red-600 text-red-500 p-3 rounded-xl focus:outline-none focus:ring-1 focus:ring-red-500 text-xl font-bold placeholder-red-500/50 text-center" />
                                    </div>
                                </div>

                                <hr className="border-gray-800" />

                                {/* Fila 2: Inputs Precios */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex flex-col gap-1">
                                        <label className="text-xs text-gray-400 ml-1">Precio Marcado ($)</label>
                                        <input type="number" placeholder="10" value={inputs.priceDollar} onChange={(e) => setInputs({...inputs, priceDollar: e.target.value})} className="w-full bg-[#2c2c2e] border border-gray-700 text-white p-3 rounded-xl focus:outline-none focus:border-gray-500 text-xl text-center" />
                                        <div className="text-[9px] text-gray-500 font-mono leading-tight px-1">{infoBaseText}</div>
                                    </div>
                                    
                                    <div className="flex flex-col gap-1">
                                        <label className="text-xs text-gray-400 ml-1">Me piden...</label>
                                        <div className="flex h-[54px] bg-[#2c2c2e] border border-gray-700 rounded-xl overflow-hidden focus-within:border-gray-500">
                                            <select value={inputs.currency} onChange={(e) => setInputs({...inputs, currency: e.target.value})} className="bg-[#3a3a3c] text-white px-2 text-sm font-bold border-r border-gray-600 outline-none appearance-none text-center min-w-[50px]">
                                                <option value="Bs">Bs</option>
                                                <option value="$">$</option>
                                            </select>
                                            <input type="number" placeholder="500" value={inputs.payAmount} onChange={(e) => setInputs({...inputs, payAmount: e.target.value})} className="w-full bg-transparent text-white p-2 text-xl text-center outline-none" />
                                        </div>
                                        <div className="text-[9px] text-gray-500 font-mono leading-tight px-1">{infoPayText}</div>
                                    </div>
                                </div>

                                {/* Resultado Sem√°foro */}
                                <div className="mt-2 p-3 rounded-2xl border border-dashed border-gray-700 bg-gray-900/50 flex flex-col items-center justify-center min-h-[110px]">
                                    <span className="text-xs text-gray-500 uppercase tracking-wider mb-1">Tasa Impl√≠cita</span>
                                    {tasaImplicita > 0 ? (
                                        <>
                                            <div className="flex items-baseline gap-2">
                                                <span className="text-4xl font-bold text-white">{tasaImplicita.toFixed(2)}</span>
                                                <span className="text-sm text-gray-400">Bs/$</span>
                                            </div>
                                            <div className={`mt-2 text-[10px] px-2 py-1 rounded uppercase font-bold tracking-wide w-full text-center ${statusColor} ${statusBg}`}>
                                                {statusText}
                                            </div>
                                            <span className="text-[10px] text-gray-400 mt-1">{analysisText}</span>
                                        </>
                                    ) : (
                                        <>
                                            <span className="text-3xl font-bold text-gray-700">--.--</span>
                                            <div className="mt-2 text-[10px] px-2 py-1 rounded uppercase font-bold tracking-wide w-full text-center text-gray-500 bg-gray-800 border border-gray-700">ESPERANDO DATOS</div>
                                        </>
                                    )}
                                </div>

                                {/* Bot√≥n Guardar */}
                                <button onClick={saveLog} className="w-full py-3 rounded-xl text-white font-bold shadow-lg active:scale-95 transition-transform" style={{ backgroundColor: COLORS.vinotinto }}>
                                    Guardar en Log
                                </button>
                            </div>

                            {/* Historial */}
                            <div className="mt-auto pt-2">
                                <button onClick={() => setShowHistory(!showHistory)} className="w-full flex items-center justify-between p-3 bg-[#1c1c1e] rounded-xl text-sm text-gray-400 hover:text-white transition-colors border border-gray-800">
                                    <span>Historial / Log ({log.length})</span>
                                    <span className={`transform transition-transform ${showHistory ? 'rotate-180' : ''}`}>‚ñº</span>
                                </button>
                                
                                <div className={`accordion-content ${showHistory ? 'open' : ''} bg-[#1c1c1e] mt-1 rounded-xl border border-gray-800 overflow-y-auto`}>
                                    {log.length === 0 ? <div className="p-4 text-center text-xs text-gray-600">No hay registros a√∫n</div> : (
                                        log.map((item) => (
                                            <div key={item.id} className="flex justify-between items-center p-3 border-b border-gray-800 last:border-0 text-xs">
                                                <span className="text-gray-500">{item.date}</span>
                                                <div className="flex gap-2">
                                                    <span className="text-gray-300">${item.price}</span>
                                                    <span className="text-gray-500">‚Üí</span>
                                                    <span className="text-gray-300">{item.paid} {item.currency}</span>
                                                </div>
                                                <span className={`font-bold ${item.status === 'red' ? 'text-red-500' : item.status === 'green' ? 'text-green-500' : 'text-yellow-500'}`}>
                                                    {item.rate}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
