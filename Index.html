<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadolar</title>
    <style>
        :root {
            --bg-dark: #000000;
            --card-bg: #121212;
            --text-main: #ffffff;
            --vinotinto: #820000;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-red: #e74c3c;
            --calc-btn: #333;
            --calc-orange: #ff9f0a;
        }

        body {
            background-color: #050505;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- CONTENEDOR FLIP (2 CARAS) --- */
        .scene {
            width: 360px;
            height: 720px;
            perspective: 1000px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 30px;
            overflow: hidden;
            background: var(--card-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .face-front { background: #000; } /* Calculadora Camuflaje */
        .face-back { transform: rotateY(180deg); display: flex; flex-direction: column; } /* Herramienta */

        /* --- CARA 1: CAMUFLAJE (iOS Calc) --- */
        .calc-ios { padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; box-sizing: border-box; }
        .screen-ios { color: white; font-size: 80px; text-align: right; margin-bottom: 20px; font-weight: 300; }
        .keypad-ios { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .btn-ios { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .bg-grey { background: #333; }
        .bg-light { background: #a5a5a5; color: black; }
        .bg-orange { background: var(--calc-orange); }
        .zero-ios { grid-column: span 2; width: 100%; border-radius: 40px; justify-content: flex-start; padding-left: 25px; }

        .secret-btn {
            position: absolute; top: 20px; left: 20px; font-size: 20px; background: none; border: none; cursor: pointer; opacity: 0.5;
        }

        /* --- CARA 2: CALCULADOLAR REAL --- */
        .header {
            padding: 15px;
            background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%);
            border-bottom: 1px solid #333;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .top-bar h2 { margin: 0; color: var(--vinotinto); font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }
        .flip-back-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; }

        /* Scroll horizontal de Tasas de Referencia */
        .ref-rates-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none; /* Firefox */
        }
        .ref-rates-container::-webkit-scrollbar { display: none; }

        .ref-pill {
            background: #222; border: 1px solid #333; border-radius: 6px;
            padding: 4px 8px; min-width: 70px; display: flex; flex-direction: column; align-items: center;
        }
        .ref-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .ref-val { 
            background: transparent; border: none; color: var(--accent-yellow); 
            font-size: 11px; font-weight: bold; width: 50px; text-align: center; font-family: monospace;
        }

        .main-content { padding: 15px; overflow-y: auto; flex-grow: 1; }

        /* Comparadora Styles */
        .comparison-box {
            background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .input-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .input-label { font-size: 11px; color: #aaa; }
        
        .input-wrapper {
            display: flex; align-items: center; background: #252525; border-radius: 8px; padding: 2px 8px; border: 1px solid #444;
        }
        .input-field {
            background: transparent; border: none; color: white; font-size: 18px; width: 100%; text-align: right; padding: 8px 0; outline: none; font-weight: bold;
        }
        .input-select {
            background: #333; color: white; border: none; font-size: 12px; padding: 4px; border-radius: 4px; margin-right: 5px;
        }
        
        .micro-convert { font-size: 10px; color: #666; margin-top: 2px; text-align: right; font-family: monospace; line-height: 1.2; }
        .mc-val { color: #ccc; }

        /* Semáforo */
        .semaphore { margin-top: 10px; text-align: center; padding: 10px; border-radius: 8px; background: #111; border: 1px dashed #333; }
        .sem-title { font-size: 10px; color: #888; text-transform: uppercase; }
        .sem-rate { font-size: 24px; font-weight: 800; color: white; margin: 5px 0; font-family: monospace; }
        .sem-status { font-size: 11px; font-weight: bold; padding: 2px 8px; border-radius: 4px; display: inline-block; }

        /* Colapsables (Log y Calculadora Real) */
        .collapsible { margin-top: 10px; border: 1px solid #333; border-radius: 8px; overflow: hidden; background: #1a1a1a; }
        .coll-header {
            padding: 10px; background: #222; color: #ccc; font-size: 12px; font-weight: bold;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .coll-content { display: none; padding: 10px; border-top: 1px solid #333; }
        .coll-content.open { display: block; }

        /* Calculadora Compacta Real */
        .mini-calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .btn-mini { padding: 10px; background: #333; border: none; color: white; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-mini:active { background: #444; }
        .btn-mini.op { background: var(--vinotinto); }
        .mini-screen { grid-column: span 4; background: #000; color: var(--accent-green); text-align: right; padding: 8px; font-family: monospace; margin-bottom: 5px; border-radius: 4px; }

        /* Log */
        .log-item { font-size: 10px; border-bottom: 1px solid #333; padding: 6px 0; color: #aaa; font-family: monospace; }
        .log-hl { color: white; font-weight: bold; }

        .save-btn { width: 100%; background: var(--vinotinto); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 12px; font-weight: bold; }

    </style>
</head>
<body>

<div class="scene">
    <div class="card" id="card">
        
        <div class="face face-front">
            <button class="secret-btn" onclick="flipCard()">⚙️</button>
            
            <div class="calc-ios">
                <div class="screen-ios" id="ios-screen">0</div>
                <div class="keypad-ios">
                    <button class="btn-ios bg-light" onclick="clearIos()">AC</button>
                    <button class="btn-ios bg-light">±</button>
                    <button class="btn-ios bg-light">%</button>
                    <button class="btn-ios bg-orange" onclick="appendIos('/')">÷</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('7')">7</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('8')">8</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('9')">9</button>
                    <button class="btn-ios bg-orange" onclick="appendIos('*')">×</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('4')">4</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('5')">5</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('6')">6</button>
                    <button class="btn-ios bg-orange" onclick="appendIos('-')">-</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('1')">1</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('2')">2</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('3')">3</button>
                    <button class="btn-ios bg-orange" onclick="appendIos('+')">+</button>
                    <button class="btn-ios bg-grey zero-ios" onclick="appendIos('0')">0</button>
                    <button class="btn-ios bg-grey" onclick="appendIos('.')">.</button>
                    <button class="btn-ios bg-orange" onclick="calcIos()">=</button>
                </div>
            </div>
        </div>

        <div class="face face-back">
            
            <div class="header">
                <div class="top-bar">
                    <h2>Calculadolar</h2>
                    <button class="flip-back-btn" onclick="flipCard()">↻</button>
                </div>
                
                <div class="ref-rates-container">
                    <div class="ref-pill"><span class="ref-label">BCV</span><input class="ref-val" id="ref-bcv" value="0.00" oninput="calcTool()"></div>
                    <div class="ref-pill"><span class="ref-label">Paralelo</span><input class="ref-val" id="ref-par" value="0.00" oninput="calcTool()"></div>
                    <div class="ref-pill"><span class="ref-label">Euro</span><input class="ref-val" id="ref-eur" value="0.00"></div>
                    <div class="ref-pill"><span class="ref-label">Binance</span><input class="ref-val" id="ref-bin" value="0.00"></div>
                    <div class="ref-pill"><span class="ref-label">Promedio</span><input class="ref-val" id="ref-avg" readonly></div>
                </div>
            </div>

            <div class="main-content">
                
                <div class="comparison-box">
                    <div class="input-row">
                        <div class="input-group" style="margin-right:10px;">
                            <span class="input-label">Precio Marcado ($)</span>
                            <div class="input-wrapper">
                                <input type="number" class="input-field" id="price-base" placeholder="10" oninput="calcTool()">
                            </div>
                            <div class="micro-convert" id="micro-base">...</div>
                        </div>

                        <div class="input-group">
                            <span class="input-label">Me piden...</span>
                            <div class="input-wrapper">
                                <select class="input-select" id="currency-ask" onchange="calcTool()">
                                    <option value="bs">Bs</option>
                                    <option value="usd">$</option>
                                </select>
                                <input type="number" class="input-field" id="price-ask" placeholder="500" oninput="calcTool()">
                            </div>
                            <div class="micro-convert" id="micro-ask">...</div>
                        </div>
                    </div>

                    <div class="semaphore">
                        <div class="sem-title">Tasa Implícita de Pago</div>
                        <div class="sem-rate" id="res-rate">--</div>
                        <span class="sem-status" id="res-status" style="background:#333; color:#666">Esperando</span>
                    </div>

                    <button class="save-btn" onclick="addLog()">Guardar en Log</button>
                </div>

                <div class="collapsible">
                    <div class="coll-header" onclick="toggleCollapsible('calc-real')">
                        <span>Calculadora Real</span> <span>▼</span>
                    </div>
                    <div class="coll-content" id="calc-real">
                        <div class="mini-screen" id="mini-screen">0</div>
                        <div class="mini-calc-grid">
                            <button class="btn-mini" onclick="miniApp('7')">7</button>
                            <button class="btn-mini" onclick="miniApp('8')">8</button>
                            <button class="btn-mini" onclick="miniApp('9')">9</button>
                            <button class="btn-mini op" onclick="miniApp('/')">÷</button>
                            <button class="btn-mini" onclick="miniApp('4')">4</button>
                            <button class="btn-mini" onclick="miniApp('5')">5</button>
                            <button class="btn-mini" onclick="miniApp('6')">6</button>
                            <button class="btn-mini op" onclick="miniApp('*')">×</button>
                            <button class="btn-mini" onclick="miniApp('1')">1</button>
                            <button class="btn-mini" onclick="miniApp('2')">2</button>
                            <button class="btn-mini" onclick="miniApp('3')">3</button>
                            <button class="btn-mini op" onclick="miniApp('-')">-</button>
                            <button class="btn-mini" onclick="miniApp('C')">C</button>
                            <button class="btn-mini" onclick="miniApp('0')">0</button>
                            <button class="btn-mini" onclick="miniApp('.')">.</button>
                            <button class="btn-mini op" onclick="miniExec()">=</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="coll-header" onclick="toggleCollapsible('log-real')">
                        <span>Historial / Log</span> <span>▼</span>
                    </div>
                    <div class="coll-content" id="log-real">
                        <div id="log-list"></div>
                        <button class="save-btn" style="background:#444; margin-top:10px;" onclick="document.getElementById('log-list').innerHTML=''">Borrar Todo</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    /* --- 1. FLIP & NAVIGATION --- */
    const card = document.getElementById('card');
    function flipCard() {
        card.classList.toggle('is-flipped');
    }

    function toggleCollapsible(id) {
        document.getElementById(id).classList.toggle('open');
    }

    /* --- 2. CAMUFLAJE IOS CALC --- */
    let iosExp = '';
    const iosScreen = document.getElementById('ios-screen');
    function appendIos(v) { 
        if(iosScreen.innerText==='0' && v!=='.') iosExp=''; 
        iosExp+=v; iosScreen.innerText=iosExp.replace('*','×').replace('/','÷'); 
    }
    function clearIos() { iosExp=''; iosScreen.innerText='0'; }
    function calcIos() { try{ iosScreen.innerText=eval(iosExp)||0; iosExp=iosScreen.innerText; }catch{ iosScreen.innerText='Error';} }

    /* --- 3. FETCH TASAS (MULTIPLE API) --- */
    async function fetchRates() {
        // Valores por defecto (Placeholders)
        let rates = { bcv: 0, par: 0, eur: 0, bin: 0 };
        
        try {
            // Intentar PyDolarVenezuela (Suele tener todo)
            const res = await fetch('https://pydolarvenezuela-api.vercel.app/api/v1/dollar?page=monitor');
            if(res.ok) {
                const data = await res.json();
                // Ajustar segun estructura de API. Esta estructura cambia mucho, 
                // aqui hago un "best guess" seguro.
                // Si la API cambia, el usuario puede editar manualmente.
                if(data.monitors) {
                    rates.bcv = parseFloat(data.monitors.bcv?.price || 0);
                    rates.par = parseFloat(data.monitors.enparalelovzla?.price || 0);
                    rates.eur = parseFloat(data.monitors.euro_bcv?.price || 0);
                    rates.bin = parseFloat(data.monitors.binance?.price || 0);
                }
            }
        } catch(e) { console.log('Error fetch, usando manual'); }

        // Si falló fetch, poner valores manuales de ejemplo o dejar en 0
        if(rates.bcv === 0) rates.bcv = 46.20; 
        if(rates.par === 0) rates.par = 54.50; 

        // Llenar inputs
        document.getElementById('ref-bcv').value = rates.bcv.toFixed(2);
        document.getElementById('ref-par').value = rates.par.toFixed(2);
        document.getElementById('ref-eur').value = rates.eur.toFixed(2);
        document.getElementById('ref-bin').value = rates.bin.toFixed(2);
        
        calcTool(); // Recalcular todo
    }

    /* --- 4. CALCULADOLAR ENGINE (INGENIERIA INVERSA) --- */
    function calcTool() {
        // Obtener tasas
        const bcv = parseFloat(document.getElementById('ref-bcv').value) || 0;
        const par = parseFloat(document.getElementById('ref-par').value) || 0;
        
        // Calcular promedio simple
        const avg = ((bcv + par) / 2).toFixed(2);
        document.getElementById('ref-avg').value = avg;

        // Obtener Inputs Usuario
        const base = parseFloat(document.getElementById('price-base').value) || 0;
        const ask = parseFloat(document.getElementById('price-ask').value) || 0;
        const currency = document.getElementById('currency-ask').value;

        // A. Conversiones Pequeñas (Izquierda: Base)
        const mb = document.getElementById('micro-base');
        if(base > 0 && bcv > 0) {
            mb.innerHTML = `
                Oficial: <span class="mc-val">Bs ${(base*bcv).toFixed(2)}</span><br>
                Paralelo: <span class="mc-val">Bs ${(base*par).toFixed(2)}</span>
            `;
        } else { mb.innerHTML = '...'; }

        // B. Conversiones Pequeñas (Derecha: Piden)
        const ma = document.getElementById('micro-ask');
        if(ask > 0) {
            if(currency === 'bs') {
                ma.innerHTML = `
                   Son: <span class="mc-val">$${(ask/par).toFixed(2)}</span> (Par)<br>
                   Son: <span class="mc-val">$${(ask/bcv).toFixed(2)}</span> (BCV)
                `;
            } else {
                ma.innerHTML = `
                   Son: <span class="mc-val">Bs ${(ask*bcv).toFixed(2)}</span> (BCV)<br>
                   Son: <span class="mc-val">Bs ${(ask*par).toFixed(2)}</span> (Par)
                `;
            }
        } else { ma.innerHTML = '...'; }

        // C. Semáforo y Tasa Implícita
        const resRate = document.getElementById('res-rate');
        const resStatus = document.getElementById('res-status');
        
        if(base > 0 && ask > 0 && bcv > 0) {
            let implicitRate = 0;
            
            if(currency === 'bs') {
                // Me piden Bs. Divido Bs entre el precio Base ($)
                implicitRate = ask / base;
            } else {
                // Me piden USD (ej: Base $10, Piden $15 pagando en Bs al oficial)
                // Convertimos el Piden a Bs (usando BCV como referencia teórica)
                const bsTheoretical = ask * bcv;
                implicitRate = bsTheoretical / base;
            }

            resRate.innerText = implicitRate.toFixed(2) + " Bs/$";

            // Lógica Semáforo
            resStatus.style.color = "white";
            if(implicitRate <= bcv * 1.01) { // 1% margen
                resStatus.style.background = "#27ae60"; 
                resStatus.innerText = "OFICIAL / CORRECTO";
            } else if (implicitRate >= par * 0.99) {
                resStatus.style.background = "#c0392b";
                resStatus.innerText = "ALERTA: PARALELO";
            } else {
                resStatus.style.background = "#f39c12";
                resStatus.innerText = "MIXTO / SOBREPRECIO";
            }

        } else {
            resRate.innerText = "--";
            resStatus.style.background = "#333";
            resStatus.innerText = "Esperando";
        }
    }

    /* --- 5. LOG SYSTEM --- */
    function addLog() {
        const base = document.getElementById('price-base').value;
        const ask = document.getElementById('price-ask').value;
        const cur = document.getElementById('currency-ask').value.toUpperCase();
        const rate = document.getElementById('res-rate').innerText;
        const stat = document.getElementById('res-status').innerText;
        
        if(!base || !ask) return;

        const time = new Date().toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit'});
        const div = document.createElement('div');
        div.className = 'log-item';
        div.innerHTML = `
            <span style="color:#666">[${time}]</span> 
            Base $${base} vs Piden ${ask}${cur} <br>
            Tasa: <span class="log-hl">${rate}</span> (${stat})
        `;
        const list = document.getElementById('log-list');
        list.insertBefore(div, list.firstChild);
        
        // Auto abrir log
        document.getElementById('log-real').classList.add('open');
    }

    /* --- 6. MINI CALCULADORA REAL --- */
    let miniExp = '';
    const miniScreen = document.getElementById('mini-screen');
    function miniApp(v) {
        if(v === 'C') { miniExp = ''; miniScreen.innerText = '0'; return; }
        if(miniScreen.innerText === '0' && v !== '.') miniExp = '';
        miniExp += v;
        miniScreen.innerText = miniExp;
    }
    function miniExec() {
        try { miniScreen.innerText = eval(miniExp); miniExp = miniScreen.innerText; }
        catch { miniScreen.innerText = 'Err'; }
    }

    // Init
    fetchRates();

</script>
</body>
</html>
