<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Tasas Venezuela</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f5f5f5;
        padding: 10px;
        margin: 0;
        font-size: 13px;
    }
    
    .container {
        max-width: 400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: #2c3e50;
        color: white;
        padding: 8px;
        text-align: left;
        font-size: 1.0em;
        font-weight: 600;
    }
    
    .tasas-section {
        padding: 8px;
        background: #f8f9fa;
    }
    
    .tasa-row {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid #e9ecef;
        gap: 10px;
    }
    
    .tasa-row:last-child {
        border-bottom: none;
    }
    
    .tasa-label {
        font-weight: 500;
        color: #2c3e50;
        font-size: 12px;
        min-width: 80px;
        flex-shrink: 0;
    }
    
    .tasa-valor {
        font-weight: 600;
        color: #e74c3c;
        font-family: monospace;
    }
    
    .tasa-input {
        width: 75px;
        padding: 3px 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: right;
        font-family: monospace;
        font-size: 12px;
    }
    
    .tabla-comparacion {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px;
    }
    
    .tabla-comparacion th {
        background: #34495e;
        color: white;
        padding: 6px 3px;
        text-align: center;
        font-weight: 600;
        font-size: 9px;
    }
    
    .tabla-comparacion td {
        padding: 6px 3px;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
        font-family: monospace;
        font-size: 10px;
    }
    
    .concepto {
        text-align: left !important;
        font-weight: 600;
        color: #2c3e50;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    }
    
    .calculado {
        background: #f9f9f9;
        color: #666;
    }
    
    .diferencia {
        background: #ffebee;
        color: #d32f2f;
        font-weight: 600;
    }
    
    .input-cell {
        padding: 3px !important;
    }
    
    .input-cell input {
        width: 100%;
        border: 1px solid #ced4da;
        background: white;
        text-align: center;
        font-family: monospace;
        font-weight: 600;
        color: #2c3e50;
        padding: 6px 4px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .input-cell input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .tasa-real-normal {
        color: #28a745;
    }
    
    .tasa-real-alta {
        color: #ffc107;
        font-weight: 700;
    }
    
    .tasa-real-critica {
        color: #dc3545;
        font-weight: 700;
        animation: parpadeo 1s infinite;
    }
    
    .icono-verde {
        color: #28a745;
    }
    
    .icono-amarillo {
        color: #ffc107;
    }
    
    .icono-rojo {
        color: #dc3545;
        animation: parpadeo 1s infinite;
    }
    
    @keyframes parpadeo {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }

    .status-message {
        font-size: 7px;
        color: #666;
        margin-top: 3px;
        text-align: left;
    }

    .timestamp {
        font-size: 6px;
        color: #999;
        text-align: left;
        margin-top: 5px;
        font-style: italic;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            Pagar@🇻🇪-1.0.0 RC1
        </div>

```
    <div class="tasas-section">
        <div class="tasa-row">
            <span class="tasa-label">Tasa BCV</span>
            <div style="display: flex; align-items: center; gap: 3px;">
                <input type="number" class="tasa-input" id="tasaBCV" value="154.01" step="0.01">
                <span style="font-size: 10px; color: #666;">Bs/$</span>
            </div>
        </div>
        <div class="tasa-row">
            <span class="tasa-label">Tasa Paralelo</span>
            <div style="display: flex; align-items: center; gap: 3px;">
                <input type="number" class="tasa-input" id="tasaParalelo" value="210.00" step="0.01">
                <span style="font-size: 10px; color: #666;">Bs/$</span>
            </div>
        </div>
        <div class="tasa-row">
            <span class="tasa-label" style="font-size: 12px; text-transform: none; line-height: 1.2; min-width: 120px;">
                Tasa Real si Pago en Bs
            </span>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span id="iconoEstado" style="font-size: 14px;" class=""></span>
                <span class="tasa-valor" id="tasaReal"></span>
                <span style="font-size: 10px; color: #666;" id="unidadTasaReal"></span>
            </div>
        </div>
        <div class="status-message" id="statusMessage"></div>
        <div class="timestamp" id="timestampBCV">Última actualización BCV: --</div>
    </div>
    
    <table class="tabla-comparacion">
        <tbody>
            <tr>
                <td class="concepto">
                    Si Pago en $
                    <br>
                    <div style="margin-top: 5px; display: flex; align-items: center; gap: 3px;">
                        <input type="checkbox" id="descuentoToggle" style="transform: scale(0.8);">
                        <span style="font-size: 9px; color: #666;">Descuento:</span>
                        <input type="number" id="descuentoInput" value="30" min="0" max="100" step="1" 
                               style="width: 30px; padding: 1px; border: 1px solid #ced4da; border-radius: 3px; text-align: center; font-size: 9px;">
                        <span style="font-size: 9px; color: #666;">%</span>
                    </div>
                    <span id="descuentoLabel" style="font-size: 8px; color: #28a745; display: none; margin-top: 2px; display: block;"></span>
                    <div style="display: flex; align-items: center; gap: 3px; margin-top: 5px;">
                        <input type="number" id="precioDolares" value="" step="0.01" placeholder="0.00" style="width: 70px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                        <span style="font-size: 12px; color: #666; font-weight: 600;">$</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="concepto">
                    Si Pago en Bs
                    <br>
                    <select id="tipoMonedaBolivares" style="margin-top: 5px; padding: 3px 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 10px;">
                        <option value="usd">Me dan precio en $</option>
                        <option value="bs">Me dan precio en Bs</option>
                    </select>
                    <div style="display: flex; align-items: center; gap: 3px; margin-top: 5px;">
                        <input type="number" id="precioBolivares" value="" step="0.01" placeholder="0.00" style="width: 70px; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                        <span style="font-size: 12px; color: #666; font-weight: 600;" id="unidadPrecioBolivares">$</span>
                    </div>
                    <div id="conversionesBolivares" style="font-size: 8px; color: #666; margin-top: 3px; line-height: 1.2;"></div>
                </td>
            </tr>
            <tr>
                <td class="concepto diferencia" style="padding: 10px 6px;">
                    <div style="display: flex; align-items: center; justify-content: flex-start;">
                        <span style="margin-right: 10px;">Diferencia:</span>
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <span id="porcentajeDiferencia" style="font-size: 16px; font-weight: 700; color: #d32f2f;"></span>
                            <span style="font-size: 12px; color: #d32f2f; font-weight: 600;">%</span>
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
```

<script>
    // Elementos del DOM
    const tasaBCVInput = document.getElementById('tasaBCV');
    const tasaParaleloInput = document.getElementById('tasaParalelo');
    const tasaRealDisplay = document.getElementById('tasaReal');
    const unidadTasaReal = document.getElementById('unidadTasaReal');
    const iconoEstado = document.getElementById('iconoEstado');
    const precioDolaresInput = document.getElementById('precioDolares');
    const precioBolivaresInput = document.getElementById('precioBolivares');
    const tipoMonedaBolivares = document.getElementById('tipoMonedaBolivares');
    const unidadPrecioBolivares = document.getElementById('unidadPrecioBolivares');
    const descuentoToggle = document.getElementById('descuentoToggle');
    const descuentoInput = document.getElementById('descuentoInput');
    const statusMessage = document.getElementById('statusMessage');
    
    // Variables para guardar últimas tasas válidas
    let ultimaTasaBCV = 154.01;
    let ultimaTasaParalelo = 210.00;
    let ultimaActualizacionBCV = null;
    
    // Variables para manejo del descuento
    let precioOriginalDolares = null;
    let descuentoActivo = false;
    
    const porcentajeDiferencia = document.getElementById('porcentajeDiferencia');
    
    function formatNumber(num, decimals = 2) {
        return num.toLocaleString('es-VE', { 
            minimumFractionDigits: decimals, 
            maximumFractionDigits: decimals 
        });
    }
    
    function setStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.style.color = isError ? '#dc3545' : '#666';
    }
    
    function updateTimestamp() {
        const now = new Date();
        const timestamp = now.toLocaleString('es-VE', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('timestampBCV').textContent = `Última actualización BCV: ${timestamp}`;
        ultimaActualizacionBCV = now;
    }
    
    function actualizarConversiones() {
        const tasaBCV = parseFloat(tasaBCVInput.value);
        const tasaParalelo = parseFloat(tasaParaleloInput.value);
        const precioBolivares = parseFloat(precioBolivaresInput.value);
        const tipoMoneda = tipoMonedaBolivares.value;
        const conversionesDiv = document.getElementById('conversionesBolivares');
        
        if (!tasaBCV || !tasaParalelo || !precioBolivares || precioBolivares <= 0) {
            conversionesDiv.innerHTML = '';
            return;
        }
        
        let html = '';
        
        if (tipoMoneda === 'usd') {
            // Me dan precio en $, mostrar conversiones a Bs
            const bsBCV = precioBolivares * tasaBCV;
            const bsParalelo = precioBolivares * tasaParalelo;
            
            // Calcular cuántos dólares necesito vender en paralelo para conseguir los Bs oficiales
            const dolaresParaVender = bsBCV / tasaParalelo;
            
            html = `(${formatNumber(bsBCV, 2)} Bs oficial • ${formatNumber(bsParalelo, 2)} Bs paralelo)<br>`;
            html += `<span style="color: #28a745;">Tendrías que vender $${formatNumber(dolaresParaVender, 2)} a la tasa paralela</span>`;
        } else {
            // Me dan precio en Bs, mostrar conversiones a $
            const usdBCV = precioBolivares / tasaBCV;
            const usdParalelo = precioBolivares / tasaParalelo;
            
            html = `($${formatNumber(usdBCV, 2)} oficial • $${formatNumber(usdParalelo, 2)} paralelo)`;
        }
        
        conversionesDiv.innerHTML = html;
    }
    
    function actualizarUnidadBolivares() {
        const tipo = tipoMonedaBolivares.value;
        unidadPrecioBolivares.textContent = tipo === 'bs' ? 'Bs' : '$';
        actualizarConversiones();
        calcular();
    }
    
    function toggleDescuento() {
        const label = document.getElementById('descuentoLabel');
        const precioActual = parseFloat(precioDolaresInput.value) || 0;
        
        if (descuentoToggle.checked) {
            // Activar descuento
            if (precioActual > 0 && !descuentoActivo) {
                precioOriginalDolares = precioActual;
                descuentoActivo = true;
            }
            
            if (precioOriginalDolares > 0) {
                const porcentaje = parseFloat(descuentoInput.value) || 0;
                const precioConDescuento = precioOriginalDolares * (1 - porcentaje / 100);
                
                precioDolaresInput.value = precioConDescuento.toFixed(2);
                label.textContent = `Con ${porcentaje}% descuento (era $${precioOriginalDolares.toFixed(2)})`;
                label.style.display = 'block';
            }
        } else {
            // Desactivar descuento
            if (precioOriginalDolares !== null) {
                precioDolaresInput.value = precioOriginalDolares.toFixed(2);
            }
            label.style.display = 'none';
            descuentoActivo = false;
            precioOriginalDolares = null;
        }
        
        calcular();
    }
    
    async function validarTasas() {
        const valorBCV = tasaBCVInput.value.trim();
        const tasaBCV = parseFloat(valorBCV);
        
        if (!valorBCV || valorBCV === '' || isNaN(tasaBCV) || tasaBCV <= 0) {
            setStatus('Campo BCV vacío o inválido. Obteniendo tasa actualizada...');
            await obtenerTasaBCV();
            
            const nuevaTasa = parseFloat(tasaBCVInput.value);
            if (!nuevaTasa || nuevaTasa <= 0 || isNaN(nuevaTasa)) {
                tasaBCVInput.value = ultimaTasaBCV.toFixed(2);
                setStatus(`No se pudo actualizar. Tasa BCV restaurada: ${ultimaTasaBCV.toFixed(2)} Bs/$`);
            }
        } else {
            ultimaTasaBCV = tasaBCV;
        }
        
        const valorParalelo = tasaParaleloInput.value.trim();
        const tasaParalelo = parseFloat(valorParalelo);
        
        if (!valorParalelo || valorParalelo === '' || isNaN(tasaParalelo) || tasaParalelo <= 0) {
            tasaParaleloInput.value = ultimaTasaParalelo.toFixed(2);
            setStatus(`Tasa Paralelo restaurada: ${ultimaTasaParalelo.toFixed(2)} Bs/$`);
        } else {
            ultimaTasaParalelo = tasaParalelo;
        }
        
        actualizarConversiones();
        calcular();
    }
    
    async function obtenerTasaBCV() {
        setStatus('Obteniendo tasa BCV...');
        
        const apis = [
            {
                name: 'DolarApi VE',
                url: 'https://ve.dolarapi.com/v1/dolares/oficial',
                parse: (data) => data.promedio
            },
            {
                name: 'GitHub API Venezuela',
                url: 'https://api.github.com/repos/fcoagz/api-dolar-venezuela/contents/api.json',
                parse: (data) => {
                    try {
                        const content = JSON.parse(atob(data.content));
                        return content.dolar?.oficial?.promedio;
                    } catch {
                        return null;
                    }
                }
            },
            {
                name: 'PyDolarVenezuela',
                url: 'https://pydolarvenezuela-api.vercel.app/api/v1/dollar?page=bcv',
                parse: (data) => data.monitors?.bcv?.price
            },
            {
                name: 'BCV Exchange',
                url: 'https://bcv-exchange-rates.vercel.app/get_bcv_exchange_rates',
                parse: (data) => {
                    if (data.data?.dolar?.value) {
                        return parseFloat(data.data.dolar.value.replace(',', '.'));
                    }
                    return null;
                }
            }
        ];
        
        for (const api of apis) {
            try {
                setStatus(`Intentando ${api.name}...`);
                const response = await fetch(api.url);
                
                if (response.ok) {
                    const data = await response.json();
                    const tasa = api.parse(data);
                    
                    if (tasa && tasa > 0 && tasa < 1000) { // Validación básica
                        tasaBCVInput.value = tasa.toFixed(2);
                        ultimaTasaBCV = tasa;
                        updateTimestamp();
                        setStatus(`Tasa BCV actualizada: ${tasa.toFixed(2)} Bs/$ (${api.name})`);
                        actualizarConversiones();
                        calcular();
                        return; // Salir al encontrar una tasa válida
                    }
                }
            } catch (error) {
                console.log(`${api.name} falló:`, error);
                continue; // Continuar con la siguiente API
            }
        }
        
        // Si ninguna API funcionó
        setStatus('No se pudo obtener tasa BCV. Usando valor anterior.', true);
    }
    
    async function obtenerTasaParalelo() {
        const apis = [
            {
                name: 'DolarApi VE Paralelo',
                url: 'https://ve.dolarapi.com/v1/dolares/paralelo',
                parse: (data) => data.promedio
            },
            {
                name: 'PyDolarVenezuela Paralelo',
                url: 'https://pydolarvenezuela-api.vercel.app/api/v1/dollar?page=enparalelovzla',
                parse: (data) => data.monitors?.enparalelovzla?.price
            },
            {
                name: 'GitHub API Paralelo',
                url: 'https://api.github.com/repos/fcoagz/api-dolar-venezuela/contents/api.json',
                parse: (data) => {
                    try {
                        const content = JSON.parse(atob(data.content));
                        return content.dolar?.enparalelovzla?.promedio;
                    } catch {
                        return null;
                    }
                }
            }
        ];
        
        for (const api of apis) {
            try {
                const response = await fetch(api.url);
                
                if (response.ok) {
                    const data = await response.json();
                    const tasa = api.parse(data);
                    
                    if (tasa && tasa > 0 && tasa < 2000) { // Validación básica para paralelo
                        tasaParaleloInput.value = tasa.toFixed(2);
                        ultimaTasaParalelo = tasa;
                        actualizarConversiones();
                        calcular();
                        return; // Salir al encontrar una tasa válida
                    }
                }
            } catch (error) {
                console.log(`${api.name} falló:`, error);
                continue;
            }
        }
        
        // Si ninguna API de paralelo funcionó, estimar basado en BCV
        const tasaBCV = parseFloat(tasaBCVInput.value);
        if (tasaBCV > 0) {
            const paraleloEstimado = tasaBCV * 1.35; // 35% más que BCV
            tasaParaleloInput.value = paraleloEstimado.toFixed(2);
            ultimaTasaParalelo = paraleloEstimado;
            actualizarConversiones();
            calcular();
        }
    }
    
    function calcular() {
        const tasaBCV = parseFloat(tasaBCVInput.value);
        const tasaParalelo = parseFloat(tasaParaleloInput.value);
        const precioDolares = parseFloat(precioDolaresInput.value);
        const precioBolivaresInput_val = parseFloat(precioBolivaresInput.value);
        const tipoMoneda = tipoMonedaBolivares.value;
        
        if (!tasaBCV || !tasaParalelo || tasaBCV <= 0 || tasaParalelo <= 0) {
            return;
        }
        
        if (!precioDolares || !precioBolivaresInput_val || precioDolares <= 0 || precioBolivaresInput_val <= 0) {
            limpiarResultados();
            return;
        }
        
        let precioBolivaresEnDolares;
        if (tipoMoneda === 'bs') {
            precioBolivaresEnDolares = precioBolivaresInput_val / tasaBCV;
        } else {
            precioBolivaresEnDolares = precioBolivaresInput_val;
        }
        
        const bolivaresQueRealmentePago = precioBolivaresEnDolares * tasaBCV;
        const tasaReal = bolivaresQueRealmentePago / precioDolares;
        
        let claseCSS = 'tasa-valor tasa-real-normal';
        let icono = '✅';
        let claseIcono = 'icono-verde';
        
        if (tasaReal > tasaBCV && tasaReal <= tasaParalelo) {
            claseCSS = 'tasa-valor tasa-real-alta';
            icono = '⚠️';
            claseIcono = 'icono-amarillo';
        } else if (tasaReal > tasaParalelo) {
            claseCSS = 'tasa-valor tasa-real-critica';
            icono = '🚨';
            claseIcono = 'icono-rojo';
        }
        
        tasaRealDisplay.className = claseCSS;
        tasaRealDisplay.textContent = formatNumber(tasaReal, 2);
        unidadTasaReal.textContent = 'Bs/$';
        iconoEstado.textContent = icono;
        iconoEstado.className = claseIcono;
        
        // Calcular solo la diferencia en porcentaje
        const porcentajeDiferenciaCalc = ((precioBolivaresEnDolares - precioDolares) / precioDolares) * 100;
        
        // Actualizar solo la diferencia
        porcentajeDiferencia.textContent = Math.round(porcentajeDiferenciaCalc);
    }
    
    function limpiarResultados() {
        tasaRealDisplay.textContent = '';
        tasaRealDisplay.className = 'tasa-valor';
        unidadTasaReal.textContent = '';
        iconoEstado.textContent = '';
        iconoEstado.className = '';
        porcentajeDiferencia.textContent = '';
    }
    
    // Event listeners
    tasaBCVInput.addEventListener('input', function() {
        actualizarConversiones();
        calcular();
    });
    tasaBCVInput.addEventListener('blur', async function() {
        const valor = tasaBCVInput.value.trim();
        if (!valor || valor === '' || isNaN(parseFloat(valor)) || parseFloat(valor) <= 0) {
            await validarTasas();
        }
    });
    
    tasaParaleloInput.addEventListener('input', function() {
        actualizarConversiones();
        calcular();
    });
    tasaParaleloInput.addEventListener('blur', async function() {
        const valor = tasaParaleloInput.value.trim();
        if (!valor || valor === '' || isNaN(parseFloat(valor)) || parseFloat(valor) <= 0) {
            await validarTasas();
        }
    });
    
    precioDolaresInput.addEventListener('input', function() {
        if (descuentoActivo) {
            descuentoToggle.checked = false;
            descuentoActivo = false;
            precioOriginalDolares = null;
            document.getElementById('descuentoLabel').style.display = 'none';
        }
        calcular();
    });
    
    precioBolivaresInput.addEventListener('input', function() {
        actualizarConversiones();
        calcular();
    });
    tipoMonedaBolivares.addEventListener('change', actualizarUnidadBolivares);
    descuentoToggle.addEventListener('change', toggleDescuento);
    descuentoInput.addEventListener('input', function() {
        if (descuentoToggle.checked) {
            toggleDescuento();
        }
    });
    
    // Inicialización
    async function inicializar() {
        setStatus('Calculadora iniciada. Obteniendo tasas actuales...');
        await obtenerTasaBCV();
        setTimeout(() => {
            obtenerTasaParalelo();
        }, 2000);
        actualizarUnidadBolivares();
    }
    
    inicializar();
</script>

</body>
</html>