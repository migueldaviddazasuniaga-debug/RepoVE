<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klculadolar Ultimate</title>
    <style>
        /* --- ESTILOS GENERALES Y ESTRUCTURA 3D --- */
        :root {
            --bg-color: #000;
            --calc-orange: #ff9f0a;
            --vinotinto: #820000;
        }

        body {
            background-color: #050505;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .scene {
            width: 380px;
            height: 750px;
            perspective: 1200px;
            position: relative;
        }

        .carousel {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        /* Definimos las 3 caras del prisma */
        .carousel-face {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            border-radius: 40px;
            overflow: hidden;
            backface-visibility: hidden; /* Oculta la cara si est√° de espaldas */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            background: #1a1a1a;
        }

        /* Matem√°tica del Prisma Triangular:
           Para un ancho de ~380px, el translateZ necesario para separarlas es aprox 110px.
           Rotamos cada cara 120 grados.
        */
        
        /* Cara 1: Calculadora (Frente) */
        .face-1 {
            transform: rotateY(0deg) translateZ(110px); /* Ajuste visual para el giro */
            background: #000;
            z-index: 3;
        }
        
        /* Cara 2: Klculadolar (Derecha) */
        .face-2 {
            transform: rotateY(120deg) translateZ(110px);
            background: #1a1a1a;
            z-index: 2;
        }

        /* Cara 3: Comparadora Legacy (Izquierda) */
        .face-3 {
            transform: rotateY(240deg) translateZ(110px);
            background: #1a1a1a; /* Color base del legacy */
            z-index: 1;
            overflow-y: auto; /* Permitir scroll si el legacy es largo */
        }

        /* Bot√≥n de Rotaci√≥n (El Engranaje/Flecha) */
        .nav-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        /* ========================================= */
        /* === ESTILOS CARA 1: CALCULADORA IOS === */
        /* ========================================= */
        .calc-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        .screen-calc {
            color: white;
            font-size: 80px;
            text-align: right;
            margin-bottom: 20px;
            font-weight: 300;
        }
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 60px; /* Espacio para el boton nav */
        }
        .btn-calc {
            width: 65px; height: 65px; border-radius: 50%; border: none;
            font-size: 30px; color: white; cursor: pointer;
        }
        .bg-grey { background-color: #333; }
        .bg-light { background-color: #a5a5a5; color: black; }
        .bg-orange { background-color: #ff9f0a; }
        .zero { grid-column: span 2; width: 100%; border-radius: 40px; text-align: left; padding-left: 25px; }


        /* ========================================= */
        /* === ESTILOS CARA 2: KLCULADOLAR === */
        /* ========================================= */
        .klc-container { padding: 20px; height: 100%; display: flex; flex-direction: column; }
        .header-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .header-tools h2 { margin: 0; color: var(--vinotinto); font-size: 24px; }
        .refresh-btn { background: none; border: 1px solid #444; color: #2ecc71; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; }
        .rates-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; background: #222; padding: 10px; border-radius: 12px; }
        .rate-box { display: flex; flex-direction: column; }
        .rate-box label { font-size: 10px; color: #888; margin-bottom: 2px; }
        .rate-box input { background: #333; border: 1px solid #444; color: var(--calc-orange); padding: 5px; border-radius: 5px; width: 100%; text-align: center; }
        .main-input-group label { display: block; color: #aaa; font-size: 12px; margin-bottom: 5px; }
        .main-input-group input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--vinotinto); color: white; font-size: 22px; border-radius: 8px; text-align: right; box-sizing: border-box; }
        .results-container { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .result-row { display: flex; justify-content: space-between; background: #252525; padding: 8px 12px; border-radius: 6px; font-size: 14px; color: white; }
        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn-tool { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-snap { background: var(--vinotinto); color: white; }
        .btn-clear { background: #444; color: white; }
        .log-container { flex-grow: 1; background: #111; border: 1px solid #333; border-radius: 8px; margin-top: 10px; padding: 8px; overflow-y: auto; font-family: monospace; font-size: 11px; color: #ccc; }


        /* ========================================= */
        /* === ESTILOS CARA 3: LEGACY (Restaurados) === */
        /* ========================================= */
        .legacy-wrapper {
            padding: 10px;
            color: white;
            font-size: 13px;
        }
        
        .legacy-header {
            background: linear-gradient(135deg, #5A0A0A 0%, #2c3e50 100%);
            color: white; padding: 10px; text-align: left; font-weight: 600; border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }
        
        .legacy-body {
            background: #2d2d2d; padding: 10px; border-radius: 0 0 8px 8px; border: 1px solid #404040;
        }

        .l-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #555; }
        .l-label { font-size: 11px; color: #e0e0e0; }
        .l-input { width: 70px; padding: 4px; background: #404040; border: 1px solid #555; color: white; text-align: right; font-family: monospace; border-radius: 4px; }
        .l-input:focus { border-color: #820000; outline: none; }
        
        .l-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .l-table th { background: #34495e; padding: 5px; font-size: 10px; }
        .l-table td { background: #2d2d2d; padding: 8px; border-bottom: 1px solid #555; vertical-align: middle; }
        
        .l-tasa-real { font-weight: 700; font-family: monospace; }
        .tr-normal { color: #2ecc71; }
        .tr-warn { color: #f1c40f; }
        .tr-alert { color: #e74c3c; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        .legacy-footer { margin-top: 10px; font-size: 9px; color: #888; text-align: center; }

    </style>
</head>
<body>

<div class="scene">
    <div class="carousel" id="carousel">
        
        <div class="carousel-face face-1">
            <div class="calc-container">
                <div class="screen-calc" id="calc-screen">0</div>
                <div class="keypad">
                    <button class="btn-calc bg-light" onclick="clearCalc()">AC</button>
                    <button class="btn-calc bg-light">¬±</button>
                    <button class="btn-calc bg-light">%</button>
                    <button class="btn-calc bg-orange" onclick="appendCalc('/')">√∑</button>

                    <button class="btn-calc bg-grey" onclick="appendCalc('7')">7</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('8')">8</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('9')">9</button>
                    <button class="btn-calc bg-orange" onclick="appendCalc('*')">√ó</button>

                    <button class="btn-calc bg-grey" onclick="appendCalc('4')">4</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('5')">5</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('6')">6</button>
                    <button class="btn-calc bg-orange" onclick="appendCalc('-')">-</button>

                    <button class="btn-calc bg-grey" onclick="appendCalc('1')">1</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('2')">2</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('3')">3</button>
                    <button class="btn-calc bg-orange" onclick="appendCalc('+')">+</button>

                    <button class="btn-calc bg-grey zero" onclick="appendCalc('0')">0</button>
                    <button class="btn-calc bg-grey" onclick="appendCalc('.')">.</button>
                    <button class="btn-calc bg-orange" onclick="calcResult()">=</button>
                </div>
                <button class="nav-btn" onclick="rotateCarousel()">‚Üª</button>
            </div>
        </div>

        <div class="carousel-face face-2">
            <div class="klc-container">
                <div class="header-tools">
                    <h2>klculadolar</h2>
                    <button class="refresh-btn" onclick="fetchRatesModern()">‚ü≥</button>
                </div>
                
                <div class="rates-grid">
                    <div class="rate-box"><label>BCV</label><input type="number" id="rate-bcv" oninput="calculateKlc()"></div>
                    <div class="rate-box"><label>Paralelo</label><input type="number" id="rate-par" oninput="calculateKlc()"></div>
                    <div class="rate-box"><label>Binance</label><input type="number" id="rate-bin" oninput="calculateKlc()"></div>
                </div>

                <div class="main-input-group">
                    <label>Monto en D√≥lares ($)</label>
                    <input type="number" id="amount-usd" placeholder="0.00" oninput="calculateKlc()">
                </div>

                <div class="results-container">
                    <div class="result-row"><span>BCV:</span><span id="res-bcv">Bs 0.00</span></div>
                    <div class="result-row"><span>Paralelo:</span><span id="res-par">Bs 0.00</span></div>
                    <div class="result-row"><span>Binance:</span><span id="res-bin">Bs 0.00</span></div>
                </div>

                <div class="actions">
                    <button class="btn-tool btn-snap" onclick="takeSnapshot()">üì∏ Snapshot</button>
                    <button class="btn-tool btn-clear" onclick="document.getElementById('log-list').innerHTML=''">Limpiar</button>
                </div>
                
                <div class="log-container" id="log-list"></div>

                <button class="nav-btn" onclick="rotateCarousel()">‚Üª</button>
            </div>
        </div>

        <div class="carousel-face face-3">
            <div class="legacy-wrapper">
                <div class="legacy-header">Calculadolar - Compacta</div>
                
                <div class="legacy-body">
                    <div style="font-size:9px; color:#aaa; margin-bottom:5px;" id="timestampBCV">Actualizando...</div>
                    
                    <div class="l-row">
                        <span class="l-label">Tasa BCV</span>
                        <input type="text" class="l-input" id="tasaBCV" placeholder="0.00">
                    </div>
                    <div class="l-row">
                        <span class="l-label">Tasa Venta (Paralelo)</span>
                        <input type="text" class="l-input" id="tasaParalelo" placeholder="0.00">
                    </div>

                    <div style="border-top:1px solid #444; margin:10px 0;"></div>

                    <div class="l-row">
                        <span class="l-label">Tasa Impl√≠cita de Pago</span>
                        <div>
                            <span id="iconoEstado"></span>
                            <span id="tasaReal" class="l-tasa-real">--</span>
                            <span style="font-size:9px; color:#aaa">Bs/$</span>
                        </div>
                    </div>

                    <table class="l-table">
                        <tr>
                            <td colspan="2">
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color:#ddd">Precio en $</span>
                                    <div>
                                        <input type="checkbox" id="descuentoToggle">
                                        <span style="font-size:9px; color:#aaa">Desc %</span>
                                        <input type="number" id="descuentoInput" value="10" style="width:25px; border:none; background:#444; color:white; text-align:center">
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; margin-top:5px;">
                                    <input type="text" id="precioDolares" class="l-input" style="width:100%; font-size:16px;" placeholder="0.00">
                                    <span style="margin-left:5px; color:#aaa;">$</span>
                                </div>
                                <div id="descuentoLabel" style="font-size:9px; color:#2ecc71; text-align:right;"></div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <span style="color:#ddd">Precio en Bs (A pagar)</span>
                                <div style="display:flex; align-items:center; margin-top:5px;">
                                    <input type="text" id="precioBolivares" class="l-input" style="width:100%; font-size:16px;" placeholder="0.00">
                                    <span style="margin-left:5px; color:#aaa;">Bs</span>
                                </div>
                                <div id="conversionesBolivares" style="font-size:9px; color:#888; margin-top:3px;"></div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="background:#222; text-align:center;">
                                <div id="areaDiferencia" style="min-height:20px;"></div>
                            </td>
                        </tr>
                    </table>
                    
                    <div class="legacy-footer">
                        Fuente API: DolarApi VE / GitHub API Vzla
                    </div>
                </div>

                <button class="nav-btn" onclick="rotateCarousel()">‚Üª</button>
            </div>
        </div>

    </div>
</div>

<script>
    /* ========================================= */
    /* === 1. L√ìGICA DE ROTACI√ìN (PRISMA) === */
    /* ========================================= */
    const carousel = document.getElementById('carousel');
    let angle = 0;

    function rotateCarousel() {
        angle -= 120; // Girar 120 grados para la siguiente cara
        carousel.style.transform = `rotateY(${angle}deg)`;
        
        // Peque√±o hack para forzar el repintado si se traba en m√≥viles
        setTimeout(() => {
            // Si vamos a la cara 3 (Legacy), intentamos actualizar tasas si est√°n vac√≠as
            if (Math.abs(angle % 360) === 240) {
                if(document.getElementById('tasaBCV').value === "") validarTasasLegacy();
            }
        }, 500);
    }

    /* ========================================= */
    /* === 2. L√ìGICA CALCULADORA IOS === */
    /* ========================================= */
    const calcScreen = document.getElementById('calc-screen');
    let currentExp = '';
    function appendCalc(val) {
        if(calcScreen.innerText === '0' && val !== '.') currentExp = '';
        currentExp += val;
        calcScreen.innerText = currentExp.replace('*','√ó').replace('/','√∑');
    }
    function clearCalc() { currentExp = ''; calcScreen.innerText = '0'; }
    function calcResult() {
        try { calcScreen.innerText = eval(currentExp) || 0; currentExp = calcScreen.innerText; } 
        catch { calcScreen.innerText = 'Err'; }
    }

    /* ========================================= */
    /* === 3. L√ìGICA KLCULADOLAR (MODERNA) === */
    /* ========================================= */
    function calculateKlc() {
        const usd = parseFloat(document.getElementById('amount-usd').value) || 0;
        const bcv = parseFloat(document.getElementById('rate-bcv').value) || 0;
        const par = parseFloat(document.getElementById('rate-par').value) || 0;
        const bin = parseFloat(document.getElementById('rate-bin').value) || 0;

        document.getElementById('res-bcv').innerText = "Bs " + (usd * bcv).toLocaleString('es-VE', {minimumFractionDigits:2});
        document.getElementById('res-par').innerText = "Bs " + (usd * par).toLocaleString('es-VE', {minimumFractionDigits:2});
        document.getElementById('res-bin').innerText = "Bs " + (usd * bin).toLocaleString('es-VE', {minimumFractionDigits:2});
    }

    // Usaremos la funci√≥n fetch del Legacy para alimentar tambi√©n la moderna
    async function fetchRatesModern() {
        const btn = document.querySelector('.refresh-btn');
        btn.innerText = '...';
        await obtenerTasaBCVLegacy(); // Reusamos la l√≥gica potente del legacy
        
        // Sincronizar valores Legacy -> Moderna
        document.getElementById('rate-bcv').value = document.getElementById('tasaBCV').value;
        document.getElementById('rate-par').value = document.getElementById('tasaParalelo').value || 0;
        
        calculateKlc();
        btn.innerText = '‚ü≥';
    }

    function takeSnapshot() {
        const usd = document.getElementById('amount-usd').value;
        const bcv = document.getElementById('rate-bcv').value;
        const list = document.getElementById('log-list');
        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #333';
        div.innerHTML = `Base $${usd} | BCV ${bcv} -> Bs ${(usd*bcv).toFixed(2)}`;
        list.prepend(div);
    }


    /* ========================================= */
    /* === 4. L√ìGICA LEGACY (RESTAURADA) === */
    /* ========================================= */
    
    // Elementos Legacy
    const l_tasaBCV = document.getElementById('tasaBCV');
    const l_tasaPar = document.getElementById('tasaParalelo');
    const l_precioUSD = document.getElementById('precioDolares');
    const l_precioBS = document.getElementById('precioBolivares');
    const l_tasaReal = document.getElementById('tasaReal');
    
    // --- Formateo Autom√°tico (Input Masking) ---
    function formatearPrecio(input) {
        let valor = input.value.replace(/[^\d]/g, '');
        if (valor === '') { input.value = ''; return 0; }
        let numero = parseInt(valor) / 100;
        input.value = numero.toFixed(2);
        return numero;
    }

    function setupInputMask(input) {
        input.addEventListener('input', (e) => {
            // Guardar cursor
            let start = input.selectionStart; 
            formatearPrecio(e.target);
            calcularLegacy();
        });
        input.addEventListener('focus', (e) => e.target.select());
    }

    setupInputMask(l_precioUSD);
    setupInputMask(l_precioBS);
    setupInputMask(l_tasaBCV);
    setupInputMask(l_tasaPar);

    // --- L√≥gica de C√°lculo Legacy ---
    function calcularLegacy() {
        const bcv = parseFloat(l_tasaBCV.value) || 0;
        const par = parseFloat(l_tasaPar.value) || 0;
        let usd = parseFloat(l_precioUSD.value) || 0;
        const bs = parseFloat(l_precioBS.value) || 0;

        // Descuento Logic
        const toggle = document.getElementById('descuentoToggle');
        if(toggle.checked && usd > 0) {
            const pct = parseFloat(document.getElementById('descuentoInput').value) || 0;
            const original = usd;
            usd = usd * (1 - pct/100);
            document.getElementById('descuentoLabel').innerText = `-${pct}% (Era $${original.toFixed(2)}) -> $${usd.toFixed(2)}`;
        } else {
            document.getElementById('descuentoLabel').innerText = '';
        }

        if(bcv <= 0 || usd <= 0 || bs <= 0) {
            l_tasaReal.innerText = "--";
            document.getElementById('areaDiferencia').innerHTML = "";
            return;
        }

        // Tasa Impl√≠cita: Cu√°ntos Bs estoy pagando por cada D√≥lar realmente
        const tasaImplicita = bs / usd;
        l_tasaReal.innerText = tasaImplicita.toFixed(2);

        // Sem√°foro de Colores
        const icono = document.getElementById('iconoEstado');
        l_tasaReal.className = "l-tasa-real";
        
        if (tasaImplicita <= bcv * 1.01) { // Margen 1%
            l_tasaReal.classList.add('tr-normal'); // Verde
            icono.innerText = "‚úÖ";
        } else if (par > 0 && tasaImplicita > par) {
            l_tasaReal.classList.add('tr-alert'); // Rojo (Pagas m√°s que el paralelo)
            icono.innerText = "üö®";
        } else {
            l_tasaReal.classList.add('tr-warn'); // Amarillo
            icono.innerText = "‚ö†Ô∏è";
        }

        // Diferencia
        const deberiaSerBs = usd * bcv;
        const diferenciaBs = bs - deberiaSerBs;
        const diferenciaUSD = diferenciaBs / bcv;
        
        const area = document.getElementById('areaDiferencia');
        const color = diferenciaBs > 0 ? '#e74c3c' : '#2ecc71';
        area.innerHTML = `Diferencia: <span style="color:${color}; font-weight:bold">$${Math.abs(diferenciaUSD).toFixed(2)} (${diferenciaBs > 0 ? 'Sobreprecio' : 'Ahorro'})</span>`;
    }

    // --- Fetch APIs (Legacy Logic) ---
    async function obtenerTasaBCVLegacy() {
        document.getElementById('timestampBCV').innerText = "Buscando tasas...";
        
        // Lista de APIs del c√≥digo original
        const apis = [
            { url: 'https://pydolarvenezuela-api.vercel.app/api/v1/dollar?page=bcv', parse: d => d.monitors.bcv.price },
            { url: 'https://ve.dolarapi.com/v1/dolares/oficial', parse: d => d.promedio }
        ];

        for (const api of apis) {
            try {
                const res = await fetch(api.url);
                if(res.ok) {
                    const data = await res.json();
                    const val = api.parse(data);
                    if(val) {
                        l_tasaBCV.value = val.toFixed(2);
                        const now = new Date().toLocaleTimeString();
                        document.getElementById('timestampBCV').innerText = `Actualizado: ${now}`;
                        calcularLegacy();
                        // Actualizar tambi√©n la cara moderna si existe
                        if(document.getElementById('rate-bcv')) document.getElementById('rate-bcv').value = val.toFixed(2);
                        return;
                    }
                }
            } catch(e) { console.log("API Fail", e); }
        }
        document.getElementById('timestampBCV').innerText = "Error red - Ingrese manual";
    }

    async function validarTasasLegacy() {
        if(!l_tasaBCV.value) await obtenerTasaBCVLegacy();
    }

    // Listeners extra
    document.getElementById('descuentoToggle').addEventListener('change', calcularLegacy);
    document.getElementById('descuentoInput').addEventListener('input', calcularLegacy);

    // Inicializar
    setTimeout(() => {
        // Intentar carga inicial suave
        validarTasasLegacy();
    }, 1000);

</script>

</body>
</html>
